<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>k8s scheduler调度器原理以及核心源码分析 | LiFengMing</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/lfm_title.png">
    <meta name="description" content="">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.74078a8e.css" as="style"><link rel="preload" href="/assets/js/app.89da10ab.js" as="script"><link rel="preload" href="/assets/js/2.8e04b068.js" as="script"><link rel="preload" href="/assets/js/26.b48ff2fb.js" as="script"><link rel="prefetch" href="/assets/js/10.5e7fe968.js"><link rel="prefetch" href="/assets/js/11.01dd294c.js"><link rel="prefetch" href="/assets/js/12.07fce99c.js"><link rel="prefetch" href="/assets/js/13.4a07fd33.js"><link rel="prefetch" href="/assets/js/14.91957f95.js"><link rel="prefetch" href="/assets/js/15.73a52305.js"><link rel="prefetch" href="/assets/js/16.af7017eb.js"><link rel="prefetch" href="/assets/js/17.e9c76188.js"><link rel="prefetch" href="/assets/js/18.255d6ad0.js"><link rel="prefetch" href="/assets/js/19.d6a4cc61.js"><link rel="prefetch" href="/assets/js/20.ab12a26a.js"><link rel="prefetch" href="/assets/js/21.efe91574.js"><link rel="prefetch" href="/assets/js/22.c87353e8.js"><link rel="prefetch" href="/assets/js/23.0d1d44af.js"><link rel="prefetch" href="/assets/js/24.9110c168.js"><link rel="prefetch" href="/assets/js/25.191ad91e.js"><link rel="prefetch" href="/assets/js/27.59bb592a.js"><link rel="prefetch" href="/assets/js/28.b52dd30a.js"><link rel="prefetch" href="/assets/js/29.b0f1a200.js"><link rel="prefetch" href="/assets/js/3.a2e7efd6.js"><link rel="prefetch" href="/assets/js/30.8d263b10.js"><link rel="prefetch" href="/assets/js/31.3de9e18a.js"><link rel="prefetch" href="/assets/js/32.7ab46bd3.js"><link rel="prefetch" href="/assets/js/33.414d9789.js"><link rel="prefetch" href="/assets/js/34.ee28dec8.js"><link rel="prefetch" href="/assets/js/35.9f5b9457.js"><link rel="prefetch" href="/assets/js/36.57abbba3.js"><link rel="prefetch" href="/assets/js/37.5d0bdfc6.js"><link rel="prefetch" href="/assets/js/38.2b079d88.js"><link rel="prefetch" href="/assets/js/39.5d0ce58a.js"><link rel="prefetch" href="/assets/js/4.d5193ec3.js"><link rel="prefetch" href="/assets/js/40.cc188046.js"><link rel="prefetch" href="/assets/js/41.1ccc15c8.js"><link rel="prefetch" href="/assets/js/42.b7f0d39a.js"><link rel="prefetch" href="/assets/js/43.aa694136.js"><link rel="prefetch" href="/assets/js/44.48cc0a37.js"><link rel="prefetch" href="/assets/js/45.b6167c45.js"><link rel="prefetch" href="/assets/js/46.5566fae8.js"><link rel="prefetch" href="/assets/js/47.785c40dd.js"><link rel="prefetch" href="/assets/js/48.4b0c2331.js"><link rel="prefetch" href="/assets/js/49.69deb0a5.js"><link rel="prefetch" href="/assets/js/5.79cbe7c1.js"><link rel="prefetch" href="/assets/js/50.83e3541f.js"><link rel="prefetch" href="/assets/js/51.022581a3.js"><link rel="prefetch" href="/assets/js/52.d4987378.js"><link rel="prefetch" href="/assets/js/53.f6e68690.js"><link rel="prefetch" href="/assets/js/54.e5908b26.js"><link rel="prefetch" href="/assets/js/55.fd21586d.js"><link rel="prefetch" href="/assets/js/56.8d5d4486.js"><link rel="prefetch" href="/assets/js/57.4614524d.js"><link rel="prefetch" href="/assets/js/58.14cde33e.js"><link rel="prefetch" href="/assets/js/59.8d1e5dd0.js"><link rel="prefetch" href="/assets/js/6.2bd77ea1.js"><link rel="prefetch" href="/assets/js/60.e6509ca1.js"><link rel="prefetch" href="/assets/js/61.32961546.js"><link rel="prefetch" href="/assets/js/62.f355dd9a.js"><link rel="prefetch" href="/assets/js/63.43230ff3.js"><link rel="prefetch" href="/assets/js/64.5af8007f.js"><link rel="prefetch" href="/assets/js/65.fe7e36f0.js"><link rel="prefetch" href="/assets/js/66.5202ab0d.js"><link rel="prefetch" href="/assets/js/67.dc162127.js"><link rel="prefetch" href="/assets/js/7.2bde0a66.js"><link rel="prefetch" href="/assets/js/8.27ed2920.js"><link rel="prefetch" href="/assets/js/9.9787f48a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.74078a8e.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/lfm_title.png" alt="LiFengMing" class="logo"> <span class="site-name can-hide">LiFengMing</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/cloudNative/" class="nav-link">云原生</a></div><div class="nav-item"><a href="/middleware/" class="nav-link">中间件</a></div><div class="nav-item"><a href="/technology/" class="nav-link">工具导航</a></div><div class="nav-item"><a href="/resourceNavigation/" class="nav-link">资源导航</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引导航" class="dropdown-title"><a href="/categories/" class="link-title">索引导航</a> <span class="title" style="display:none;">索引导航</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><a href="/pages/c92c72/" class="nav-link">关于作者</a></div> <a href="https://github.com/fengmingli" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://fastly.jsdelivr.net/gh/xugaoyi/image_store/blog/20200103123203.jpg"> <div class="blogger-info"><h3>LiFengMing</h3> <span>IT届李哥</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/cloudNative/" class="nav-link">云原生</a></div><div class="nav-item"><a href="/middleware/" class="nav-link">中间件</a></div><div class="nav-item"><a href="/technology/" class="nav-link">工具导航</a></div><div class="nav-item"><a href="/resourceNavigation/" class="nav-link">资源导航</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引导航" class="dropdown-title"><a href="/categories/" class="link-title">索引导航</a> <span class="title" style="display:none;">索引导航</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><a href="/pages/c92c72/" class="nav-link">关于作者</a></div> <a href="https://github.com/fengmingli" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>编程语言</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span> 问题排查手册</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>容器编排技术</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/a0cdb3/" class="sidebar-link">Linux 之 iptables 原理分析</a></li><li><a href="/pages/15b341/" class="sidebar-link">K8s常见问题排查技巧</a></li><li><a href="/pages/6c277b/" class="sidebar-link">K8s应用存储与存储卷</a></li><li><a href="/pages/7a6137/" aria-current="page" class="active sidebar-link">k8s scheduler调度器原理以及核心源码分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/7a6137/#简介" class="sidebar-link">简介</a></li><li class="sidebar-sub-header level2"><a href="/pages/7a6137/#调度流程" class="sidebar-link">调度流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/7a6137/#调度组件" class="sidebar-link">调度组件</a></li><li class="sidebar-sub-header level4"><a href="/pages/7a6137/#policy" class="sidebar-link">Policy</a></li><li class="sidebar-sub-header level4"><a href="/pages/7a6137/#informer" class="sidebar-link">Informer</a></li><li class="sidebar-sub-header level4"><a href="/pages/7a6137/#scheduler-pipeline" class="sidebar-link">Scheduler Pipeline</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/7a6137/#源码分析" class="sidebar-link">源码分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/7a6137/#代码目录结构" class="sidebar-link">代码目录结构</a></li><li class="sidebar-sub-header level3"><a href="/pages/7a6137/#启动流程" class="sidebar-link">启动流程</a></li><li class="sidebar-sub-header level4"><a href="/pages/7a6137/#_1-scheduler-run" class="sidebar-link">1. Scheduler.Run</a></li><li class="sidebar-sub-header level4"><a href="/pages/7a6137/#_2-scheduler-scheduleone" class="sidebar-link">2. Scheduler.scheduleOne</a></li><li class="sidebar-sub-header level3"><a href="/pages/7a6137/#调度核心逻辑" class="sidebar-link">调度核心逻辑</a></li><li class="sidebar-sub-header level3"><a href="/pages/7a6137/#参考文章" class="sidebar-link">参考文章</a></li></ul></li></ul></li><li><a href="/pages/68ed2e/" class="sidebar-link">k8s scheduler调度算法及源码分析</a></li><li><a href="/pages/294716/" class="sidebar-link">k8s scheduler之拓展调度器</a></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/cloudNative/#云原生" data-v-06225672>云原生</a></li><li data-v-06225672><a href="/cloudNative/#容器编排技术" data-v-06225672>容器编排技术</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/fengmingli" target="_blank" title="作者" class="beLink" data-v-06225672>LiFengMing</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-06-18</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">k8s scheduler调度器原理以及核心源码分析<!----></h1>  <div class="theme-vdoing-content content__default"><div class="custom-block tip"><p class="custom-block-title">k8s 调度器要解决哪些问题？</p> <p><strong>通俗点说，k8s整个调度的过程就是在回答两个问题：</strong></p> <p><strong>1. 候选节点有哪些？</strong></p> <p><strong>2. 候选节点中最适合的是哪个？</strong></p></div> <h2 id="简介"><a href="#简介" class="header-anchor">#</a> 简介</h2> <p>在 Kubernetes 项目中，默认调度器的主要职责，就是为一个新创建出来的 Pod，寻找一个最合适的节点（Node）。</p> <p>而这里“最合适”的含义，包括两层：</p> <ul><li>从集群所有的节点中，根据调度算法挑选出所有可以运行该 Pod 的节点；</li> <li>从第一步的结果中，再根据调度算法挑选一个最符合条件的节点作为最终结果。</li></ul> <p>所以在具体的调度流程中，默认调度器会首先调用一组叫作 Predicate（预选） 的调度算法，来检查每个 Node。然后，再调用一组叫作 Priority（优选） 的调度算法，来给上一步得到的结果里的每个 Node 打分。最终的调度结果，就是得分最高的那个 Node。</p> <h2 id="调度流程"><a href="#调度流程" class="header-anchor">#</a> 调度流程</h2> <h3 id="调度组件"><a href="#调度组件" class="header-anchor">#</a> 调度组件</h3> <p>下图是 kube-scheduler 的主要几大组件：</p> <p><img src="https://lfm-image-1258982381.cos.ap-shanghai.myqcloud.com/image/cncf/k8s-scheduler.jpeg" alt=""></p> <h4 id="policy"><a href="#policy" class="header-anchor">#</a> Policy</h4> <p>Scheduler 的调度策略启动配置目前支持三种方式，配置文件 / 命令行参数 / ConfigMap。调度策略可以配置指定调度主流程中要用哪些过滤器 (Predicates)、打分器 (Priorities) 、外部扩展的调度器 (Extenders)，以及最新支持的 SchedulerFramwork 的自定义扩展点 (Plugins)。</p> <h4 id="informer"><a href="#informer" class="header-anchor">#</a> Informer</h4> <p>Scheduler 在启动的时候通过 K8s 的 informer 机制以 List+Watch 从 kube-apiserver 获取调度需要的数据例如：Pods、Nodes、Persistant Volume(PV), Persistant Volume Claim(PVC) 等等，并将这些数据做一定的预处理作为调度器的的 Cache。</p> <h4 id="scheduler-pipeline"><a href="#scheduler-pipeline" class="header-anchor">#</a> Scheduler Pipeline</h4> <p>通过 <strong>Informer</strong> 将需要调度的 Pod 插入 Queue 中，Pipeline 会循环从 Queue Pop 等待调度的 Pod 放入 Pipeline 执行。</p> <p>调度流水线 (Schedule Pipeline) 主要有三个阶段：Scheduler Thread，Wait Thread，Bind Thread。</p> <ul><li><p><strong>Scheduler Thread 阶段</strong>: 从如上的架构图可以看到 Schduler Thread 会经历 Pre Filter -&gt; Filter -&gt; Post Filter-&gt; Score -&gt; Reserve，可以简单理解为 Filter -&gt; Score -&gt; Reserve(预定)。</p> <ul><li>Filter 阶段用于选择符合 Pod Spec 描述的 Nodes；</li> <li>Score 阶段用于从 Filter 过后的 Nodes 进行打分和排序；</li> <li>Reserve 阶段将 Pod 跟排序后的最优 Node 的 NodeCache 中，表示这个 Pod 已经分配到这个 Node 上, 让下一个等待调度的 Pod 对这个 Node 进行 Filter 和 Score 的时候能看到刚才分配的 Pod。</li></ul></li> <li><p><strong>Wait Thread 阶段:</strong> 这个阶段可以用来等待 Pod 关联的资源的 Ready 等待，例如等待 PVC 的 PV 创建成功等等；</p></li> <li><p><strong>Bind Thread 阶段:</strong> 用于将 Pod 和 Node 的关联持久化 Kube APIServer。</p></li></ul> <p>整个调度流水线只有在 Scheduler Thread 阶段是串行的一个 Pod 一个 Pod 的进行调度，在 Wait 和 Bind 阶段 Pod 都是异步并行执行。</p> <h2 id="源码分析"><a href="#源码分析" class="header-anchor">#</a> 源码分析</h2> <h3 id="代码目录结构"><a href="#代码目录结构" class="header-anchor">#</a> 代码目录结构</h3> <p><a href="https://github.com/kubernetes/kubernetes/tree/v1.14.4/pkg/scheduler" target="_blank" rel="noopener noreferrer">kubernetes 版本: v1.14.4<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，scheduler的pkg部分核心代码目录结构如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>scheduler
├── algorithm       # 主要包含调度的算法
│   ├── predicates  # 预选的策略
│   ├── priorities  # 优选的策略
│   ├── scheduler_interface.go  # ScheduleAlgorithm、SchedulerExtender接口定义
│   └── types.go    # 使用到的type的定义
├── algorithmprovider
│   ├── defaults   # 默认算法的初始化操作，包括预选和优选策略
│   ├── plugins.go
│   └── plugins_test.go
├── core
│   ├── extender.go   #拓展调度相关配置
│   ├── generic_scheduler.go  # genericScheduler,主要包含默认调度器的调度逻辑
├── equivalence
├── eventhandlers.go
├── factory
│   ├── factory.go  # 主要包括NewConfigFactory、NewPodInformer，监听pod事件来更新调度队列
│   ├── plugins.go
├── internal
│   ├── cache  # scheduler调度使用到的cache
│   └── queue  # 调度使用到的队列，主要用来存储需要被调度的pod
├── metrics    
│   └── metrics.go  # 主要给prometheus使用
├── nodeinfo
│   ├── host_ports.go
│   ├── node_info.go
├── scheduler.go  # pkg部分的Run入口(核心代码)，主要包含Run、scheduleOne、schedule、preempt等函数
└── volumebinder
    └── volume_binder.go
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h3 id="启动流程"><a href="#启动流程" class="header-anchor">#</a> 启动流程</h3> <h4 id="_1-scheduler-run"><a href="#_1-scheduler-run" class="header-anchor">#</a> 1. <a href="https://github1s.com/kubernetes/kubernetes/blob/v1.14.4/pkg/scheduler/scheduler.go#L248" target="_blank" rel="noopener noreferrer">Scheduler.Run<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h4> <blockquote><p>此部分代码位于pkg/scheduler/scheduler.go</p></blockquote> <p>此处为具体调度逻辑的入口。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// Run begins watching and scheduling. It waits for cache to be synced, then starts a goroutine and returns immediately.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>sched <span class="token operator">*</span>Scheduler<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>sched<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function">WaitForCacheSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">go</span> wait<span class="token punctuation">.</span><span class="token function">Until</span><span class="token punctuation">(</span>sched<span class="token punctuation">.</span>scheduleOne<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sched<span class="token punctuation">.</span>config<span class="token punctuation">.</span>StopEverything<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="_2-scheduler-scheduleone"><a href="#_2-scheduler-scheduleone" class="header-anchor">#</a> 2. <a href="https://github1s.com/kubernetes/kubernetes/blob/v1.14.4/pkg/scheduler/scheduler.go#L435" target="_blank" rel="noopener noreferrer">Scheduler.scheduleOne<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h4> <blockquote><p>此部分代码位于pkg/scheduler/scheduler.go</p></blockquote> <p><code>scheduleOne</code>主要为单个pod选择一个适合的节点，为调度逻辑的核心函数。</p> <p><strong>对单个pod进行调度的基本流程如下：</strong></p> <ol><li>通过podQueue的待调度队列中弹出需要调度的pod。</li> <li>通过具体的调度算法为该pod选出合适的节点，其中调度算法就包括预选和优选两步策略。</li> <li>如果上述调度失败，则会尝试抢占机制，将优先级低的pod剔除，让优先级高的pod调度成功。</li> <li>将该pod和选定的节点进行假性绑定，存入scheduler cache中，方便具体绑定操作可以异步进行。</li> <li>实际执行绑定操作，将node的名字添加到pod的节点相关属性中。</li></ol> <p>完整代码如下：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// scheduleOne does the entire scheduling workflow for a single pod.  It is serialized on the scheduling algorithm's host fitting.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>sched <span class="token operator">*</span>Scheduler<span class="token punctuation">)</span> <span class="token function">scheduleOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	plugins <span class="token operator">:=</span> sched<span class="token punctuation">.</span>config<span class="token punctuation">.</span>PluginSet
	<span class="token comment">// Remove all plugin context data at the beginning of a scheduling cycle.</span>
	<span class="token keyword">if</span> plugins<span class="token punctuation">.</span><span class="token function">Data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Ctx <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		plugins<span class="token punctuation">.</span><span class="token function">Data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Ctx<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

  <span class="token comment">//1.获取下一个POD</span>
	pod <span class="token operator">:=</span> sched<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function">NextPod</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// pod could be nil when schedulerQueue is closed</span>
	<span class="token keyword">if</span> pod <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> pod<span class="token punctuation">.</span>DeletionTimestamp <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		sched<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Recorder<span class="token punctuation">.</span><span class="token function">Eventf</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> v1<span class="token punctuation">.</span>EventTypeWarning<span class="token punctuation">,</span> <span class="token string">&quot;FailedScheduling&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;skip schedule deleting pod: %v/%v&quot;</span><span class="token punctuation">,</span> pod<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span> pod<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
		klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Skip schedule deleting pod: %v/%v&quot;</span><span class="token punctuation">,</span> pod<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span> pod<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Attempting to schedule pod: %v/%v&quot;</span><span class="token punctuation">,</span> pod<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span> pod<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>

	<span class="token comment">// 同步尝试为 pod 找到合适的位置。（调度算法的核心）</span>
	start <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	scheduleResult<span class="token punctuation">,</span> err <span class="token operator">:=</span> sched<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> fitError<span class="token punctuation">,</span> ok <span class="token operator">:=</span> err<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>core<span class="token punctuation">.</span>FitError<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>util<span class="token punctuation">.</span><span class="token function">PodPriorityEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> sched<span class="token punctuation">.</span>config<span class="token punctuation">.</span>DisablePreemption <span class="token punctuation">{</span>
				klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Pod priority feature is not enabled or preemption is disabled by scheduler configuration.&quot;</span> <span class="token operator">+</span>
					<span class="token string">&quot; No preemption is performed.&quot;</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				preemptionStartTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				sched<span class="token punctuation">.</span><span class="token function">preempt</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> fitError<span class="token punctuation">)</span>
				metrics<span class="token punctuation">.</span>PreemptionAttempts<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				metrics<span class="token punctuation">.</span>SchedulingAlgorithmPremptionEvaluationDuration<span class="token punctuation">.</span><span class="token function">Observe</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">SinceInSeconds</span><span class="token punctuation">(</span>preemptionStartTime<span class="token punctuation">)</span><span class="token punctuation">)</span>
	metrics<span class="token punctuation">.</span>DeprecatedSchedulingAlgorithmPremptionEvaluationDuration<span class="token punctuation">.</span><span class="token function">Observe</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">SinceInMicroseconds</span><span class="token punctuation">(</span>preemptionStartTime<span class="token punctuation">)</span><span class="token punctuation">)</span>
				metrics<span class="token punctuation">.</span>SchedulingLatency<span class="token punctuation">.</span><span class="token function">WithLabelValues</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span>PreemptionEvaluation<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Observe</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">SinceInSeconds</span><span class="token punctuation">(</span>preemptionStartTime<span class="token punctuation">)</span><span class="token punctuation">)</span>
				metrics<span class="token punctuation">.</span>DeprecatedSchedulingLatency<span class="token punctuation">.</span><span class="token function">WithLabelValues</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span>PreemptionEvaluation<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Observe</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">SinceInSeconds</span><span class="token punctuation">(</span>preemptionStartTime<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			metrics<span class="token punctuation">.</span>PodScheduleFailures<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;error selecting node for pod: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			metrics<span class="token punctuation">.</span>PodScheduleErrors<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	metrics<span class="token punctuation">.</span>SchedulingAlgorithmLatency<span class="token punctuation">.</span><span class="token function">Observe</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">SinceInSeconds</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span>
	metrics<span class="token punctuation">.</span>DeprecatedSchedulingAlgorithmLatency<span class="token punctuation">.</span><span class="token function">Observe</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">SinceInMicroseconds</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span>
	assumedPod <span class="token operator">:=</span> pod<span class="token punctuation">.</span><span class="token function">DeepCopy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  
<span class="token comment">// 在假设 pod 之前先假设卷。</span>
<span class="token comment">// 如果所有卷都完全绑定，则 allBound 为真，将跳过绑定。</span>
<span class="token comment">// 否则，卷的绑定是在假定 pod 之后但在 pod 绑定之前开始的。</span>
<span class="token comment">// 如果需要卷绑定，此函数会修改 'assumedPod'。</span>
	allBound<span class="token punctuation">,</span> err <span class="token operator">:=</span> sched<span class="token punctuation">.</span><span class="token function">assumeVolumes</span><span class="token punctuation">(</span>assumedPod<span class="token punctuation">,</span> scheduleResult<span class="token punctuation">.</span>SuggestedHost<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;error assuming volumes: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		metrics<span class="token punctuation">.</span>PodScheduleErrors<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Run &quot;reserve&quot; plugins.</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> pl <span class="token operator">:=</span> <span class="token keyword">range</span> plugins<span class="token punctuation">.</span><span class="token function">ReservePlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> pl<span class="token punctuation">.</span><span class="token function">Reserve</span><span class="token punctuation">(</span>plugins<span class="token punctuation">,</span> assumedPod<span class="token punctuation">,</span> scheduleResult<span class="token punctuation">.</span>SuggestedHost<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;error while running %v reserve plugin for pod %v: %v&quot;</span><span class="token punctuation">,</span> pl<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> assumedPod<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			sched<span class="token punctuation">.</span><span class="token function">recordSchedulingFailure</span><span class="token punctuation">(</span>assumedPod<span class="token punctuation">,</span> err<span class="token punctuation">,</span> SchedulerError<span class="token punctuation">,</span>
				fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;reserve plugin %v failed&quot;</span><span class="token punctuation">,</span> pl<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			metrics<span class="token punctuation">.</span>PodScheduleErrors<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// assume modifies `assumedPod` by setting NodeName=scheduleResult.SuggestedHost</span>
  <span class="token comment">//假设通过设置NodeName=scheduleResult.SuggestedHost</span>
	err <span class="token operator">=</span> sched<span class="token punctuation">.</span><span class="token function">assume</span><span class="token punctuation">(</span>assumedPod<span class="token punctuation">,</span> scheduleResult<span class="token punctuation">.</span>SuggestedHost<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;error assuming pod: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		metrics<span class="token punctuation">.</span>PodScheduleErrors<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// bind the pod to its host asynchronously (we can do this b/c of the assumption step above).</span>
  <span class="token comment">//将 pod 异步绑定到其主机（我们可以按照上述假设步骤执行此操作）</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// Bind volumes first before Pod</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>allBound <span class="token punctuation">{</span>
			err <span class="token operator">:=</span> sched<span class="token punctuation">.</span><span class="token function">bindVolumes</span><span class="token punctuation">(</span>assumedPod<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;error binding volumes: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
				metrics<span class="token punctuation">.</span>PodScheduleErrors<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// Run &quot;prebind&quot; plugins.</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> pl <span class="token operator">:=</span> <span class="token keyword">range</span> plugins<span class="token punctuation">.</span><span class="token function">PrebindPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			approved<span class="token punctuation">,</span> err <span class="token operator">:=</span> pl<span class="token punctuation">.</span><span class="token function">Prebind</span><span class="token punctuation">(</span>plugins<span class="token punctuation">,</span> assumedPod<span class="token punctuation">,</span> scheduleResult<span class="token punctuation">.</span>SuggestedHost<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				approved <span class="token operator">=</span> <span class="token boolean">false</span>
				klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;error while running %v prebind plugin for pod %v: %v&quot;</span><span class="token punctuation">,</span> pl<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> assumedPod<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
				metrics<span class="token punctuation">.</span>PodScheduleErrors<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>approved <span class="token punctuation">{</span>
				sched<span class="token punctuation">.</span><span class="token function">Cache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ForgetPod</span><span class="token punctuation">(</span>assumedPod<span class="token punctuation">)</span>
				<span class="token keyword">var</span> reason <span class="token builtin">string</span>
				<span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					msg <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;prebind plugin %v rejected pod %v.&quot;</span><span class="token punctuation">,</span> pl<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> assumedPod<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
					klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
					err <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
					reason <span class="token operator">=</span> v1<span class="token punctuation">.</span>PodReasonUnschedulable
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					reason <span class="token operator">=</span> SchedulerError
				<span class="token punctuation">}</span>
				sched<span class="token punctuation">.</span><span class="token function">recordSchedulingFailure</span><span class="token punctuation">(</span>assumedPod<span class="token punctuation">,</span> err<span class="token punctuation">,</span> reason<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		err <span class="token operator">:=</span> sched<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>assumedPod<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">.</span>Binding<span class="token punctuation">{</span>
			ObjectMeta<span class="token punctuation">:</span> metav1<span class="token punctuation">.</span>ObjectMeta<span class="token punctuation">{</span>Namespace<span class="token punctuation">:</span> assumedPod<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span> Name<span class="token punctuation">:</span> assumedPod<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> UID<span class="token punctuation">:</span> assumedPod<span class="token punctuation">.</span>UID<span class="token punctuation">}</span><span class="token punctuation">,</span>
			Target<span class="token punctuation">:</span> v1<span class="token punctuation">.</span>ObjectReference<span class="token punctuation">{</span>
				Kind<span class="token punctuation">:</span> <span class="token string">&quot;Node&quot;</span><span class="token punctuation">,</span>
				Name<span class="token punctuation">:</span> scheduleResult<span class="token punctuation">.</span>SuggestedHost<span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
		metrics<span class="token punctuation">.</span>E2eSchedulingLatency<span class="token punctuation">.</span><span class="token function">Observe</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">SinceInSeconds</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span>
		metrics<span class="token punctuation">.</span>DeprecatedE2eSchedulingLatency<span class="token punctuation">.</span><span class="token function">Observe</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">SinceInMicroseconds</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;error binding pod: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			metrics<span class="token punctuation">.</span>PodScheduleErrors<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;pod %v/%v is bound successfully on node %v, %d nodes evaluated, %d nodes were found feasible&quot;</span><span class="token punctuation">,</span> assumedPod<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span> assumedPod<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> scheduleResult<span class="token punctuation">.</span>SuggestedHost<span class="token punctuation">,</span> scheduleResult<span class="token punctuation">.</span>EvaluatedNodes<span class="token punctuation">,</span> scheduleResult<span class="token punctuation">.</span>FeasibleNodes<span class="token punctuation">)</span>
			metrics<span class="token punctuation">.</span>PodScheduleSuccesses<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br></div></div><h3 id="调度核心逻辑"><a href="#调度核心逻辑" class="header-anchor">#</a> 调度核心逻辑</h3> <p>sched.scheduleOne会被wait.UntilWithContext定时调用，直到ctx.Done()返回true为止。sched.scheduleOne是核心实现，主要做了以下几件事：</p> <ol><li>通过sched.NextPod()函数从优先队列中获取一个优先级最高的待调度Pod资源对象，如果没有获取到，那么该方法会阻塞住；</li> <li>通过sched.Algorithm.Schedule调度函数执行Predicates的调度算法与Priorities算法，挑选出一个合适的节点；</li> <li>当没有找到合适的节点时，调度器会尝试调用prof.RunPostFilterPlugins抢占低优先级的Pod资源对象的节点；</li> <li>将该pod和选定的节点进行假性绑定，存入scheduler cache中，方便具体绑定操作可以异步进行。</li> <li>实际执行绑定操作，将node的名字添加到pod的节点相关属性中。</li></ol> <p>其中核心的部分为通过具体的调度算法选出调度节点的过程，即<code>genericScheduler.Schedule</code>的实现部分。该部分包括预选和优选两个部分。</p> <p><code>genericScheduler.Schedule</code>调度的基本流程如下：</p> <ol><li>对pod做基本性检查，目前主要是对pvc的检查。</li> <li>通过<code>findNodesThatFit</code>预选策略选出满足调度条件的node列表。</li> <li>通过<code>PrioritizeNodes</code>优选策略给预选的node列表中的node进行打分。</li> <li>在打分的node列表中选择一个分数最高的node作为调度的节点。</li></ol> <h3 id="参考文章"><a href="#参考文章" class="header-anchor">#</a> 参考文章</h3> <ul><li><a href="https://blog.csdn.net/weixin_33924770/article/details/92574450" target="_blank" rel="noopener noreferrer">深入分析Kubernetes Scheduler的NominatedPods<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/fengmingli/edit/master/docs/01.云原生/13.容器编排技术/13005.k8s scheduler调度器原理及代码分析.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=scheduler" title="标签">#scheduler</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/12/03, 22:49:00</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/6c277b/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">K8s应用存储与存储卷</div></a> <a href="/pages/68ed2e/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">k8s scheduler调度算法及源码分析</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/6c277b/" class="prev">K8s应用存储与存储卷</a></span> <span class="next"><a href="/pages/68ed2e/">k8s scheduler调度算法及源码分析</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/97863b2244/"><div>
            云原生资源
            <!----></div></a> <span class="date">05-25</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/9786d0311/"><div>
            kafka版本迭代说明
            <!----></div></a> <span class="date">03-11</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/9786dd2/"><div>
            docker-compose 快速搭建kafka集群
            <!----></div></a> <span class="date">03-02</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:lifengming666@gmail.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/fengmingli" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2018-2023
    <span>LiFengMing | <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.89da10ab.js" defer></script><script src="/assets/js/2.8e04b068.js" defer></script><script src="/assets/js/26.b48ff2fb.js" defer></script>
  </body>
</html>
